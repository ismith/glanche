#!/bin/bash
shopt -s extglob
set -e

# Partial implementation of `blanche`, as a wrapper for `gam`.
#
# [x] -m | --members
# [ ] -v | --verbose
# [x] -i | --info
# [x] -a | --add member
# [x] -d | --delete member
# [ ] -f | --filename # ?
# [x] -C | --create
# [x] -R | --rename
# [x] -D | --delete-list
# [x] -L | --show-lists
# [ ] --show-config
# [x] -n | --dry-run
# [x] expand lists - gam expects foo@example.com, but we can assume @example.com

# [x] add_member should accept a comma-separated list
# [ ] no-args: opts
# [ ] long opts
# [ ] domain: configurable
# [ ] aliases: configurable
# [ ] docs
# [x] validate that list is not empty, and contains no spaces
# [x] require confirmation for delete-list

function gam_cmd() {
    if [[ $DRY_RUN ]]; then
        echo "gam $@"
    else
        gam $@
    fi
}

# This function will handle config of user aliasing - coming soon. For now, it
# just takes a string arg and returns it.
function process_user() {
    local str=$1

    case $str in
        *           ) echo ${str};;
    esac
}

# This needs to be a configurable default domain.
function process_list() {
    case $1 in
        *@* ) echo $1;;
        *   ) echo "${1}@projectalloy.org";;
    esac
}

# - show_lists does not require that $list be set, but all other sub-commands ('verbs') do
# - list may not contain a space
function validate_list() {
    if [[ $verb != 'show_lists' ]]; then
        if [[ ! "$list" ]]; then
            echo "\$list must be set but is not."
            exit 1
        fi
        if [[ "$list" =~ ' ' ]]; then
            echo "\$list: '${list}' contains a space, something went wrong in arg parsing."
            exit 1
        fi
    fi
}

# default
# TODO: add verbose flag
function members () {
    gam_cmd print group-members group $list 2>/dev/null \
        | cut -d, -f 3 \
        | tail -n +2
}

function info() {
    gam_cmd info group $list 2>/dev/null
}

# add_member takes in a comma-separated list of members (or a single member) and
# adds them to the list
function add_member() {
    local input=$1
    local member=''

    for member in $(echo $input | tr "," " "); do
      member=$(process_user $member)
      gam_cmd update group $list add member user $member 2>/dev/null
    done
}

function delete_member() {
    local member=$(process_user $1)

    gam_cmd update group $list remove member user $member 2>/dev/null
}

function create_group() {
    gam_cmd create group $list \
        allow_external_members true message_moderation_level moderate_none \
        who_can_post_message anyone_can_post is_archived true 2>/dev/null
}

function rename_group() {
    local newemail=$1

    gam_cmd update group $list email $newemail 2>/dev/null
}

function delete_group() {
    local confirm=''

    read -p "Deleting $list: are you sure (y/n)? " -n 1 confirm
    echo
    case "$confirm" in
      y|Y ) echo "Ok." ; gam_cmd delete group $list 2>/dev/null ;;
      n|N ) echo "Cancelling." ;;
      * ) echo "Invalid response." ; delete_group;;
    esac
}

function show_lists() {
    gam_cmd print groups 2>/dev/null \
        | tail -n +2
}

### Main
while getopts "mia:d:CR:DnL" opt; do
    verb='';
    list='';
    arg=''

    case $opt in
        m) verb='members';;
        i) verb='info' ;;
        a) verb='add_member'; arg=$OPTARG;;
        d) verb='delete_member'; arg=$OPTARG;;
        C) verb='create_group';;
        R) verb='rename_group'; arg=$(process_list $OPTARG);;
        D) verb='delete_group';;
        L) verb='show_lists';;
        n) DRY_RUN=1;;
    esac
done
shift $(expr $OPTIND - 1)
list=$@

validate_list $list
list=$(process_list $list)

if [[ "$verb" ]]; then
    $verb $arg
else
    # TODO: docs
    echo "TODO: docs"
fi
